<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>দৈনিক হিসাব অ্যাপ</title>

    <style>
        body { font-family: Arial; margin:0; padding:0; background:#f4f4f4; }
        .container { max-width:1200px; margin:20px auto; background:white; padding:20px; border-radius:8px; }

        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        h1 { color:#007bff; }

        button { padding:10px 15px; border:none; border-radius:5px; background:#007bff; color:white; cursor:pointer; }
        button:hover { background:#0056b3; }

        #authOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
        .colorful-loader { width:60px; height:60px; border:8px solid #f3f3f3; border-radius:50%; border-top:8px solid #FF5733; border-right:8px solid #C70039; border-bottom:8px solid #900C3F; border-left:8px solid #FFC300; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .waiting-text { margin-top:20px; font-size:18px; font-weight:bold; background:linear-gradient(to right,#FF5733,#FFC300,#33FF57,#3380FF); -webkit-background-clip:text; color:transparent; }

        .login-container { max-width:400px; margin:70px auto; background:white; padding:25px; border-radius:10px; text-align:center; box-shadow:0 0 10px rgba(0,0,0,0.1); }

        .table-container { overflow-x:auto; }
        table { width:100%; border-collapse:collapse; min-width:780px; }
        th,td { border:1px solid #ddd; padding:8px; text-align:left; }
        th { background:#f2f2f2; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; width:90%; max-width:500px; border-radius:10px; position:relative; }
        .close-btn { position:absolute; top:10px; right:15px; font-size:28px; cursor:pointer; }

        .popup-step-content { display:none; }

        .popup-controls { display:flex; justify-content:space-between; margin-top:25px; }

        #payTypePopup { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:10000; }

        .payTypeBtn.disabled { opacity:0.4; pointer-events:none; }

        @media(max-width:768px){
            table { min-width:900px; }
        }
    </style>
</head>

<body>

<div id="authOverlay">
    <div class="colorful-loader"></div>
    <div class="waiting-text">Waiting please...</div>
</div>

<div id="loginUI" class="login-container" style="display:none;">
    <h2>Login</h2>
    <p>Email: <b>Asad@my.com</b></p>
    <input type="password" id="password" placeholder="Password" style="width:100%; padding:10px;">
    <button id="loginBtn" style="width:100%; margin-top:10px;">Login</button>
    <p id="errorMsg" style="color:red; margin-top:10px;"></p>
</div>

<div id="appUI" class="container" style="display:none;">

    <div class="header">
        <h1>দৈনিক হিসাব</h1>

        <div>
            <button id="addNewBtn">➕ Add</button>
            <button id="logoutBtn" style="background:#dc3545;">Logout</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Place</th>
                    <th>Rent</th>
                    <th>Basic</th>
                    <th id="payHeader" style="cursor:pointer; color:#007bff;">Pay</th>
                    <th>Due</th>
                    <th>Total Due</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody id="dataTableBody"></tbody>

            <tr style="background:#ffe599; font-weight:bold;">
                <td colspan="3" style="text-align:center;">Total</td>
                <td id="sumRent">0</td>
                <td id="sumBasic">0</td>
                <td id="sumPay">0</td>
                <td id="sumDue">0</td>
                <td id="sumTotalDue">0</td>
                <td></td>
            </tr>
        </table>
    </div>

</div>

<div id="dataModal" class="modal">
    <div class="modal-content">

        <span class="close-btn">&times;</span>
        <h2>নতুন এন্ট্রি</h2>

        <form id="dataForm">

            <div id="step1" class="popup-step-content">
                <label>Date</label>
                <input type="date" id="inputDate">
                <p>Day: <b id="autoDay"></b></p>
            </div>

            <div id="step2" class="popup-step-content">
                <label>Place</label>
                <input type="text" id="inputPlace">
            </div>

            <div id="step3" class="popup-step-content">
                <label>Rent</label>
                <input type="number" id="inputRent" value="0">
            </div>

            <div id="step4" class="popup-step-content">
                <label>Basic</label>
                <input type="number" id="inputBasic" value="0">
            </div>

            <div id="step5" class="popup-step-content">
                <label>Pay</label>
                <input type="number" id="inputPay" value="0">
                <p>Due: <b id="autoDue"></b></p>

                <p style="font-weight:bold;">Pay Type</p>

                <div style="display:flex; gap:10px;">
                    <button type="button" class="payTypeBtn" data-type="hand"
                        style="flex:1; border:1px solid #007bff; background:white; color:#007bff;">
                        হাত
                    </button>
                    <button type="button" class="payTypeBtn" data-type="bkash"
                        style="flex:1; border:1px solid #d9534f; background:white; color:#d9534f;">
                        বিকাশ
                    </button>
                </div>

                <input type="hidden" id="inputPayType" value="">
            </div>

            <div class="popup-controls">
                <button type="button" id="prevBtn" style="background:#6c757d;">Previous</button>
                <button type="button" id="nextBtn">Next</button>
                <button id="confirmBtn" type="submit" style="display:none;">Save</button>
            </div>

        </form>
    </div>
</div>

<div id="payTypePopup">
    <div style="background:white; padding:20px; border-radius:10px; width:250px;">
        <h3 style="text-align:center;">Filter Pay</h3>
        <button class="ptBtn" data-type="all" style="width:100%; margin-bottom:10px;">All</button>
        <button class="ptBtn" data-type="hand" style="width:100%; margin-bottom:10px;">হাত</button>
        <button class="ptBtn" data-type="bkash" style="width:100%;">বিকাশ</button>
    </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";


const firebaseConfig={
    apiKey:"AIzaSyBADXYUfnJTupNF6FEmRASiHNvZpIpZ_jQ",
    authDomain:"duret-d9981.firebaseapp.com",
    projectId:"duret-d9981"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginUI=document.getElementById("loginUI");
const appUI=document.getElementById("appUI");
const dataModal=document.getElementById("dataModal");

const inputDate=document.getElementById("inputDate");
const inputPlace=document.getElementById("inputPlace");
const inputRent=document.getElementById("inputRent");
const inputBasic=document.getElementById("inputBasic");
const inputPay=document.getElementById("inputPay");
const inputPayType=document.getElementById("inputPayType");

const autoDay=document.getElementById("autoDay");
const autoDue=document.getElementById("autoDue");


onAuthStateChanged(auth, (user)=>{
    document.getElementById("authOverlay").style.display="none";

    if(user){
        loginUI.style.display="none";
        appUI.style.display="block";
        loadData(user.uid);
    } else {
        loginUI.style.display="block";
    }
});

document.getElementById("loginBtn").onclick=async()=>{
    try{
        await signInWithEmailAndPassword(auth, "Asad@my.com", document.getElementById("password").value);
    }catch(e){ document.getElementById("errorMsg").innerText="Wrong Password"; }
};

document.getElementById("logoutBtn").onclick=()=> signOut(auth);


const payTypeBtns=document.querySelectorAll(".payTypeBtn");

function setPayType(type){
    const pay = parseFloat(inputPay.value) || 0;

    if(pay === 0){
        inputPayType.value = "";
        return;
    }

    inputPayType.value = type;

    payTypeBtns.forEach(b=>{
        if(b.dataset.type===type){
            b.style.background = (type==="bkash") ? "#d9534f" : "#007bff";
            b.style.color="white";
        } else {
            b.style.background="white";
            b.style.color=(b.dataset.type==="bkash")?"#d9534f":"#007bff";
        }
    });
}

function updatePayTypeButtons(){
    const pay = parseFloat(inputPay.value) || 0;

    if(pay === 0){
        inputPayType.value="";
        payTypeBtns.forEach(btn=>{
            btn.classList.add("disabled");
        });
    } else {
        payTypeBtns.forEach(btn=>{
            btn.classList.remove("disabled");
        });
    }
}

inputPay.oninput = ()=>{
    calcDue();
    updatePayTypeButtons();
};
updatePayTypeButtons();


let allData=[];
let currentFilter="all";

function loadData(uid){
    const q=query(collection(db,`users/${uid}/entries`),orderBy("date","asc"));

    onSnapshot(q,snap=>{
        allData=[];

        snap.forEach(docu=>{
            const d=docu.data();
            allData.push({
                id:docu.id,
                date:d.date,
                place:d.place,
                rent:d.rent||0,
                basic:d.basic||0,
                pay:d.pay||0,
                payType:d.payType||""
            });
        });

        applyFilter(currentFilter);
    });
}

function renderTable(list){
    const body=document.getElementById("dataTableBody");
    body.innerHTML="";

    let running=0;

    list.forEach(e=>{
        const due=e.basic-e.pay;
        running+=due;

        let tr=document.createElement("tr");

        tr.innerHTML=`
            <td>${e.date}</td>
            <td>${ new Date(e.date+"T00:00:00").toLocaleDateString("bn-BD",{weekday:"long"}) }</td>
            <td>${e.place}</td>
            <td>${e.rent.toFixed(2)}</td>
            <td>${e.basic.toFixed(2)}</td>

            <td>
                ${e.pay.toFixed(2)}
                <small>
                    ${
                        e.payType
                        ? (e.payType=="bkash" ? "বিকাশ" : "হাত")
                        : ""
                    }
                </small>
            </td>

            <td>${due.toFixed(2)}</td>
            <td>${running.toFixed(2)}</td>

            <td>
                <button class="editBtn" data-id="${e.id}">Edit</button>
                <button class="deleteBtn" style="background:#dc3545;" data-id="${e.id}">Delete</button>
            </td>
        `;

        body.appendChild(tr);
    });

    document.querySelectorAll(".deleteBtn").forEach(btn=>{
        btn.onclick=()=> deleteDoc(doc(db,`users/${auth.currentUser.uid}/entries`,btn.dataset.id));
    });

    document.querySelectorAll(".editBtn").forEach(btn=>{
        btn.onclick=()=> openEdit(btn.dataset.id);
    });

    calcTotals(list);
}

function calcTotals(list){
    let r=0,b=0,p=0,d=0,t=0;

    list.forEach(e=>{
        r+=e.rent;
        b+=e.basic;
        p+=e.pay;

        const due=e.basic-e.pay;
        d+=due;
        t+=due;
    });

    sumRent.innerText=r.toFixed(2);
    sumBasic.innerText=b.toFixed(2);
    sumPay.innerText=p.toFixed(2);
    sumDue.innerText=d.toFixed(2);
    sumTotalDue.innerText=t.toFixed(2);
}

document.getElementById("payHeader").onclick=()=>{
    document.getElementById("payTypePopup").style.display="flex";
};

document.querySelectorAll(".ptBtn").forEach(b=>{
    b.onclick=()=>{
        applyFilter(b.dataset.type);
        document.getElementById("payTypePopup").style.display="none";
    };
});

function applyFilter(type){
    currentFilter=type;
    let list=allData;

    if(type==="hand") list=allData.filter(a=>a.payType==="hand");
    if(type==="bkash") list=allData.filter(a=>a.payType==="bkash");

    renderTable(list);
}


document.getElementById("addNewBtn").onclick=()=>{
    dataForm.reset();
    delete dataForm.dataset.editKey;

    inputPayType.value="";
    updatePayTypeButtons();

    currentStep=0;
    showStep(0);
    dataModal.style.display="flex";
};

document.querySelector(".close-btn").onclick=()=> dataModal.style.display="none";


let currentStep=0;
const steps=["step1","step2","step3","step4","step5"];

function showStep(s){
    steps.forEach((id,i)=>{
        document.getElementById(id).style.display=i===s?"block":"none";
    });

    prevBtn.disabled = s===0;
    nextBtn.style.display = (s<4)?"inline-block":"none";
    confirmBtn.style.display = (s===4)?"inline-block":"none";
}

showStep(0);

prevBtn.onclick=()=>{ if(currentStep>0){ currentStep--; showStep(currentStep);} };
nextBtn.onclick=()=>{ if(currentStep<4){ currentStep++; showStep(currentStep);} };

inputDate.onchange=()=>{
    const d=new Date(inputDate.value+"T00:00:00");
    autoDay.innerText=d.toLocaleDateString("bn-BD",{weekday:"long"});
};

function calcDue(){
    const b=parseFloat(inputBasic.value)||0;
    const p=parseFloat(inputPay.value)||0;
    autoDue.innerText=(b-p).toFixed(2);
}
inputBasic.oninput=calcDue;
inputPay.oninput=calcDue;


dataForm.onsubmit=async(e)=>{
    e.preventDefault();
    const uid=auth.currentUser.uid;

    const data={
        date:inputDate.value,
        place:inputPlace.value,
        rent:+inputRent.value,
        basic:+inputBasic.value,
        pay:+inputPay.value,
        payType:inputPayType.value || ""
    };

    if(dataForm.dataset.editKey){
        await updateDoc(doc(db,`users/${uid}/entries`,dataForm.dataset.editKey),data);
        delete dataForm.dataset.editKey;
    } else {
        await addDoc(collection(db,`users/${uid}/entries`),data);
    }

    dataModal.style.display="none";
};

function openEdit(id){
    const e=allData.find(x=>x.id===id);

    inputDate.value=e.date;
    inputPlace.value=e.place;
    inputRent.value=e.rent;
    inputBasic.value=e.basic;
    inputPay.value=e.pay;

    inputPayType.value=e.payType || "";
    updatePayTypeButtons();
    setPayType(e.payType);

    calcDue();

    dataForm.dataset.editKey=id;

    currentStep=0;
    showStep(0);
    dataModal.style.display="flex";
}

</script>

</body>
</html>